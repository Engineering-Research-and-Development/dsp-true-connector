@startuml

participant CONSUMER as c
participant PROVIDER as p

== ContractRequestMessage ==

c->p : https://provider.com/negotiations/request
note left
	ContractRequestMessage
	consumerPid
	callbackAddress: https://consumer.com/
end note

p->p: create ContractNegotiation, uses consumePid, generates providerPid;\nstatus **REQUESTED**
p->c: ContractNegotiation
note left
	ContractNegotiation - status **REQUESTED**
end note


== ContractOfferMessage ==
alt Provider
note over p
	ContractNegotiation.status: **OFFERED**
end note

p->p: create ContractOfferMessage; callbackAddress https://provider.com
p->c: https://consumer.com/negotiations/offers
note over c
	ContractNegotiation.state **OFFERED**
end note
c->p: 201 Created with body ContractNegotiation state **OFFERED**
p->p: Handle f request not 200

	alt accepts
		c<-c: ContractNegotiationEventMessage,\nstatus **ACCEPTED**
		c->p: callbackAddress + negotiations/:providerPid/events
		p->c: 200 OK
	else provider - current offer created by consumer?
		p->c : 400, ContractNegotiationError
	end alt accepts
end alt provider

alt Consumer
	c<-c: ContractRequestMessage,\ncalbackAddress https://consumer.com/
	c->p: https://provider.com/negotiations/:providerPid/request
	p->c: 200 OK
end alt consumer

== Provider decide what to do with offer ==
note over p
	Provider decide what to do 
	with requested offer -> accepts it
end note

== ContractAgreementMessage ==

note over p
	Provider update status of
	ContractNegotiation to **AGREED**
end note

p->p: ContractAgreementMessage \ncallbackAddress: https://provider.com
p->c: callbackAddress + /negotiations/:consumerPid/agreement

c<-c: ContractNegotiation.status **AGREED**
c->p : 200 OK
p->p: handle if not 200 OK\nupdate ContractNegotiation.status

== ContractAgreementVerificationMessage ==
note over c
 ContractNegotiation.status = **VERIFIED**
end note
c<-c: ContractAgreementVerificationMessage
c->p: callbackAddress + /negotiations/:providerPid/agreement/verification

p->p: ContractNegotiation.status **VERIFIED**
p->c: 200 OK 
c<-c: handle if not 200 OK\nupdate ContractNegotiation.status

== ContractNegotiationEventMessage ==
note over p
	ContractNegotiation.status **FINALIZED**
end note

p->p: ContractNegotiationEventMessage, eventType **FINALIZED**

p->c: callback + /negotiations/:consumerPid/events
c<-c: ContractNEgotation.status **FINALIZED**
c->p: 200 OK
p->p: handle if not 200 OK\nupdate ContractNegotiation.status

@enduml