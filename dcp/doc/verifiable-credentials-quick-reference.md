# Verifiable Credentials: Quick Reference Cheat Sheet

## ‚ö†Ô∏è IMPORTANT: Setup Order

**Always follow this sequence:**

1. **Configure properties** (application.properties)
2. **Start the connector** (mvn spring-boot:run)
3. **Send API requests**

---

## üöÄ Quick Commands

### 1. Configure First (Before Starting!)

Edit `connector/src/main/resources/application.properties`:

```properties
# Enable DCP Module
dcp.enabled=true

# Connector DID (REQUIRED for authentication tokens)
dcp.connector.did=did:web:connector-a

# Configure Trusted Issuers
dcp.trusted-issuers=did:web:issuer.example,did:web:dataspace-authority

# Enable VP Authentication (optional)
dcp.vp.enabled=true
dcp.vp.scope=MembershipCredential,OrganizationCredential

# MongoDB Connection
spring.data.mongodb.uri=mongodb://localhost:27017/connector_db

# Debug Logging (recommended for testing)
logging.level.it.eng.dcp=DEBUG
```

**‚ö†Ô∏è Critical:** `dcp.connector.did` is REQUIRED for `SelfIssuedIdTokenService` to generate authentication tokens for credential requests and deliveries.

### 2. Start the Connector (After Configuration!)
```bash
cd connector
mvn spring-boot:run
```

**Wait for:** `Started ApplicationConnector in X seconds` message

### 3. Verify DCP Module is Running
```bash
curl http://localhost:8080/actuator/health
```

**Expected response:**
```json
{
  "status": "UP",
  "components": {
    "mongo": {"status": "UP"},
    ...
  }
}
```

---

## üìã Common API Calls (After Connector is Started!)

**‚ö†Ô∏è Authentication Note:** 
- All DCP credential requests/deliveries require authentication tokens
- Tokens are automatically generated by `SelfIssuedIdTokenService` in Java code
- For manual curl testing, tokens must be generated separately
- Tokens are JWT format, signed with ES256, valid for 5 minutes

### 1. Request Credentials (Holder)

**Automatic Token (Java API):**
```java
// Token generated automatically
credentialIssuanceClient.requestCredentials(issuerDid, requestMessage);
```

**Manual curl:**
```bash
# Note: Requires valid self-issued ID token
curl -X POST http://localhost:8080/issuer/credentials \
  -H "Authorization: Bearer <self-issued-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "@context": ["https://w3id.org/dspace-dcp/v1.0/dcp.jsonld"],
    "type": "CredentialRequestMessage",
    "holderPid": "did:web:localhost%3A8081:holder",
    "credentials": [{"id": "membership-credential"}]
  }'
```

**Response:** `Location: /issuer/requests/req-abc123`

### 2. Approve Request (Issuer)
```bash
curl -X POST http://localhost:8080/issuer/requests/req-abc123/approve \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 3. Query Presentation (Verifier)
```bash
curl -X POST http://localhost:8081/dcp/presentations/query \
  -H "Authorization: Bearer <verifier-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "@context": ["https://w3id.org/dspace-dcp/v1.0/dcp.jsonld"],
    "type": "PresentationQueryMessage",
    "scope": ["MembershipCredential"]
  }'
```

**Response:** VP JWT (real example from production)
```
eyJraWQiOiJvOVdzdTN2SF9LTXM3VE5UMFA4UDlKTHRIMmJRZWUtbVRwNVBleUdDNHQ4IiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJkaWQ6d2ViOmxvY2FsaG9zdDo4MDgwIiwic3ViIjoiZGlkOndlYjpsb2NhbGhvc3Q6ODA4MCIsInZwIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIl0sInR5cGUiOlsiVmVyaWZpYWJsZVByZXNlbnRhdGlvbiJdLCJ2ZXJpZmlhYmxlQ3JlZGVudGlhbCI6W3sidHlwZSI6Ik1lbWJlcnNoaXBDcmVkZW50aWFsIiwiZm9ybWF0Ijoiand0Iiwiand0IjoiZXlKcmFXUWlPaUp2T1ZkemRUTjJTRjlMVFhNM1ZFNVVNRkE0VURsS1RIUklNbUpSWldVdGJWUndOVkJsZVVkRE5IUTRJaXdpWVd4bklqb2lSVk15TlRZaWZRLmV5SnpkV0lpT2lKa2FXUTZkMlZpT214dlkyRnNhRzl6ZERvNE1EZ3dJaXdpYVhOeklqb2laR2xrT25kbFlqcHNiMk5oYkdodmMzUTZPREE0TUNJc0ltVjRjQ0k2TVRjNU56TXpNVFEwTVN3aWFXRjBJam94TnpZMU56azFORFF4TENKMll5STZleUpqY21Wa1pXNTBhV0ZzVTNWaWFtVmpkQ0k2ZXlKdFpXMWlaWEp6YUdsd1ZIbHdaU0k2SWxCeVpXMXBkVzBpTENKdFpXMWlaWEp6YUdsd1NXUWlPaUpOUlUxQ1JWSXRNakZpTmpNNU1HSWlMQ0pwWkNJNkltUnBaRHAzWldJNmJHOWpZV3hvYjNOME9qZ3dPREFpTENKemRHRjBkWE1pT2lKQlkzUnBkbVVpZlN3aWRIbHdaU0k2V3lKV1pYSnBabWxoWW14bFEzSmxaR1Z1ZEdsaGJDSXNJazFsYldKbGNuTm9hWEJEY21Wa1pXNTBhV0ZzSWwwc0lrQmpiMjUwWlhoMElqcGJJbWgwZEhCek9pOHZkM2QzTG5jekxtOXlaeTh5TURFNEwyTnlaV1JsYm5ScFlXeHpMM1l4SWl3aWFIUjBjSE02THk5bGVHRnRjR3hsTG05eVp5OWpjbVZrWlc1MGFXRnNjeTkyTVNKZGZTd2lhblJwSWpvaWRYSnVPblYxYVdRNll6WTBOR0l5T0RJdE9XTTROQzAwTkRjekxXSmpZak10T0RGa05UbGpNVEprT1RVekluMC5pTXR4NGxHOWVscDdXSXZVS29hZjB3RmczdGVGY1FSN05sVTBNNkU3dzd0alFvVXlOOEFTd2Q1enBpNjliSXFuMWtMZE5vWTFRbUEtZjNTNVVVYkdIQSJ9XSwicHJvZmlsZUlkIjoiVkMxMV9TTDIwMjFfSldUIn0sImlhdCI6MTc2NTg4NTkzNiwianRpIjoidXJuOnV1aWQ6OTAwNzU3OGUtMzBlZC00YjUzLTk2MDMtOTUwNzJlMjkyZWMxIn0.XxLJAu1PsFPfFEmdBxSZMWo5BshBpciC7-NbsxLE27S6-jAHQjpJhafCokzXqxdkozJ0_4cywnJsRS_IWRtzAA
```

**Decoded Payload:**
- `iss`/`sub`: `did:web:localhost:8080` (holder's DID)
- `vp.type`: `["VerifiablePresentation"]`
- `vp.verifiableCredential`: Contains embedded JWT VC for MembershipCredential
- `vp.profileId`: `VC11_SL2021_JWT`
- `iat`: 1765885936 (Dec 16, 2025)
- `jti`: `urn:uuid:9007578e-30ed-4b53-9603-95072e292ec1`

**Use this token with:** `Authorization: Bearer <VP-JWT>`

---

## üîß Configuration Properties

### Essential DCP Configuration

**File:** `connector/src/main/resources/application.properties`

```properties
# Enable DCP Module (REQUIRED)
dcp.enabled=true

# Trusted Issuers (REQUIRED - comma-separated DIDs)
dcp.trusted-issuers=did:web:issuer.example,did:web:dataspace-authority

# VP Authentication for Protocol Endpoints (OPTIONAL)
dcp.vp.enabled=true
dcp.vp.scope=MembershipCredential,OrganizationCredential

# MongoDB Configuration (REQUIRED)
spring.data.mongodb.uri=mongodb://localhost:27017/connector_db
spring.data.mongodb.database=connector_db

# Debug Logging (RECOMMENDED for development)
logging.level.it.eng.dcp=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web.client.RestTemplate=DEBUG

# Server Configuration
server.port=8080
```

### Common Configuration Scenarios

**Scenario 1: Basic Setup (Development)**
```properties
dcp.enabled=true
dcp.trusted-issuers=did:web:localhost%3A8080
spring.data.mongodb.uri=mongodb://localhost:27017/connector_db
logging.level.it.eng.dcp=DEBUG
```

**Scenario 2: Production with VP Auth**
```properties
dcp.enabled=true
dcp.trusted-issuers=did:web:dataspace-authority,did:web:issuer-prod
dcp.vp.enabled=true
dcp.vp.scope=MembershipCredential
spring.data.mongodb.uri=mongodb://mongo-prod:27017/connector_db
logging.level.it.eng.dcp=INFO
```

**Scenario 3: Disable DCP Module**
```properties
dcp.enabled=false
```

---

## üóÇÔ∏è Key File Locations

### DCP Module
```
dcp/src/main/java/it/eng/dcp/
‚îú‚îÄ‚îÄ rest/
‚îÇ   ‚îú‚îÄ‚îÄ DcpController.java          # Holder endpoints (/dcp/*)
‚îÇ   ‚îî‚îÄ‚îÄ IssuerController.java       # Issuer endpoints (/issuer/*)
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ HolderService.java          # Credential storage
‚îÇ   ‚îú‚îÄ‚îÄ PresentationService.java    # VP creation
‚îÇ   ‚îú‚îÄ‚îÄ PresentationValidationService.java  # VP validation
‚îÇ   ‚îî‚îÄ‚îÄ IssuerService.java          # Credential issuance
‚îî‚îÄ‚îÄ model/
    ‚îú‚îÄ‚îÄ VerifiableCredential.java   # VC model
    ‚îî‚îÄ‚îÄ VerifiablePresentation.java # VP model
```

### Connector Authentication
```
connector/src/main/java/it/eng/connector/configuration/
‚îú‚îÄ‚îÄ VcVpAuthenticationFilter.java   # Extract VP from headers
‚îú‚îÄ‚îÄ VcVpAuthenticationProvider.java # Validate VP
‚îî‚îÄ‚îÄ WebSecurityConfig.java          # Security config
```

### Configuration Files
```
connector/src/main/resources/
‚îî‚îÄ‚îÄ application.properties          # Main configuration
```

---

## üîç MongoDB Queries

### Connect to MongoDB
```bash
# Via Docker
docker exec -it <mongo-container-id> mongosh

# Or locally
mongosh mongodb://localhost:27017/connector_db
```

### Useful Queries

**List All Credentials:**
```javascript
db.verifiable_credentials.find().pretty()
```

**Find Credentials by Type:**
```javascript
db.verifiable_credentials.find({
  credentialType: "MembershipCredential"
}).pretty()
```

**Find Credentials by Holder:**
```javascript
db.verifiable_credentials.find({
  holderDid: "did:web:localhost:8080"
}).pretty()
```

**Check Expired Credentials:**
```javascript
db.verifiable_credentials.find({
  expirationDate: { $lt: new Date() }
}).pretty()
```

**List Credential Requests:**
```javascript
db.credential_requests.find().pretty()
```

**Check Request Status:**
```javascript
db.credential_requests.find({
  _id: "req-abc123"
}).pretty()
```

**Count Credentials by Type:**
```javascript
db.verifiable_credentials.aggregate([
  { $group: { _id: "$credentialType", count: { $sum: 1 } } }
])
```

---

## üêõ Troubleshooting Quick Fixes

### Issue 1: "dcp.enabled property not found"
**Cause:** DCP module not on classpath or properties not loaded

**Fix:**
```properties
# Add to application.properties
dcp.enabled=true
```

**Verify:**
```bash
# Check logs for: "DcpHolderAutoConfiguration matched"
grep "DcpHolderAutoConfiguration" logs/connector.log
```

---

### Issue 2: "Untrusted issuer"
**Cause:** Issuer DID not in trusted issuers list

**Fix:**
```properties
# Add issuer to trusted list
dcp.trusted-issuers=did:web:issuer.example,did:web:another-issuer
```

**Verify:**
```bash
# Check application startup logs
grep "Trusted issuers" logs/connector.log
```

---

### Issue 3: "Credentials not being saved"
**Cause:** MongoDB not running or connection failed

**Fix:**
```bash
# Check MongoDB status
docker ps | grep mongo

# Or start MongoDB
docker run -d -p 27017:27017 --name mongodb mongo:7.0.12

# Verify connection in application.properties
spring.data.mongodb.uri=mongodb://localhost:27017/connector_db
```

**Verify:**
```bash
curl http://localhost:8080/actuator/health | jq .components.mongo
```

---

### Issue 4: "DID resolution fails"
**Cause:** DID format incorrect or DID document not accessible

**Fix:**
```bash
# Ensure colons are URL-encoded
# ‚úÖ Correct: did:web:localhost%3A8080:holder
# ‚ùå Wrong:   did:web:localhost:8080:holder

# Verify DID document accessible
curl https://localhost:8080/.well-known/did.json
```

---

### Issue 5: "VP validation failed"
**Cause:** Multiple possible reasons

**Fix - Enable Debug Logging:**
```properties
logging.level.it.eng.dcp=DEBUG
logging.level.it.eng.dcp.holder.service.PresentationValidationService=TRACE
```

**Check logs for:**
- "Profile mismatch" ‚Üí VCs have different profileIds
- "Credential expired" ‚Üí Check expiration dates
- "Signature verification failed" ‚Üí Key mismatch
- "Untrusted issuer" ‚Üí Add to trusted-issuers

---

### Issue 6: "Authentication fails on protocol endpoints"
**Cause:** VP auth not configured or token format incorrect

**Fix:**
```properties
# Enable VP authentication
dcp.vp.enabled=true
dcp.vp.scope=MembershipCredential
```

**Check filter order in logs:**
```bash
grep "VcVpAuthenticationFilter" logs/connector.log
```

---

## üìä Status Codes Reference

| Code | Meaning | Common Cause | Action |
|------|---------|--------------|--------|
| 200 OK | Success | Request completed | Continue |
| 201 Created | Credential request created | New request submitted | Note `Location` header |
| 400 Bad Request | Invalid payload | JSON format error | Validate JSON syntax |
| 401 Unauthorized | Missing/invalid auth | No/invalid Bearer token | Add `Authorization` header |
| 403 Forbidden | Untrusted issuer | Issuer not in trusted list | Add to `dcp.trusted-issuers` |
| 404 Not Found | Request ID not found | Invalid request ID | Check ID from Location header |
| 500 Internal Error | Server error | Various causes | Check logs with DEBUG enabled |

---

## üîê DID Format Reference

### Web DID Format
```
did:web:{domain}[:{port}][:{path}][#{fragment}]
```

### Examples with Resolution

| DID | Resolves To | Notes |
|-----|-------------|-------|
| `did:web:example.com` | `https://example.com/.well-known/did.json` | No port |
| `did:web:localhost%3A8080` | `https://localhost:8080/.well-known/did.json` | Port URL-encoded |
| `did:web:localhost%3A8080:holder` | `https://localhost:8080/holder/.well-known/did.json` | With path |
| `did:web:dataspace-issuer#key-1` | Same as base + fragment `#key-1` | References key in doc |

### URL Encoding Rules
```
: (colon)  ‚Üí  %3A
/ (slash)  ‚Üí  %2F
? (query)  ‚Üí  %3F
```

**Common Mistake:**
```
‚ùå did:web:localhost:8080        (Won't resolve correctly)
‚úÖ did:web:localhost%3A8080      (Correct)
```

---

## üìù Example Credential Structures

### JWT VC (Compact Format)
```
eyJraWQiOiJkaWQ6ZXhhbXBsZTppc3N1ZXI0NTYja2V5LTEiLCJhbGciOiJFUzI1NiJ9.eyJzdWIi...
```

**Decoded Header:**
```json
{
  "alg": "ES256",
  "typ": "JWT",
  "kid": "did:example:issuer456#key-1"
}
```

**Decoded Payload:**
```json
{
  "iss": "did:example:issuer456",
  "sub": "did:example:holder123",
  "vc": {
    "type": ["VerifiableCredential", "MembershipCredential"],
    "credentialSubject": {
      "id": "did:example:holder123",
      "membershipType": "Premium",
      "membershipId": "MEMBER-2024-001"
    }
  },
  "iat": 1733363431,
  "exp": 1764899431,
  "jti": "urn:uuid:credential-12345678..."
}
```

---

### JSON-LD VC
```json
{
  "@context": [
    "https://www.w3.org/2018/credentials/v1",
    "https://example.org/credentials/v1"
  ],
  "type": ["VerifiableCredential", "MembershipCredential"],
  "issuer": "did:example:issuer456",
  "issuanceDate": "2024-12-08T12:30:00Z",
  "expirationDate": "2025-12-08T12:30:00Z",
  "credentialSubject": {
    "id": "did:example:holder123",
    "membershipType": "Premium"
  },
  "proof": {
    "type": "JsonWebSignature2020",
    "verificationMethod": "did:example:issuer456#key-1",
    "created": "2024-12-08T12:30:00Z",
    "proofPurpose": "assertionMethod",
    "jws": "eyJhbGc..."
  }
}
```

---

## üéØ Pre-Flight Testing Checklist

Before sending API requests, verify:

- [ ] **Configuration Set**
  - [ ] `dcp.enabled=true` in application.properties
  - [ ] `dcp.trusted-issuers` configured with valid DIDs
  - [ ] MongoDB URI correct
  
- [ ] **Infrastructure Running**
  - [ ] MongoDB is running (`docker ps | grep mongo`)
  - [ ] MongoDB is accessible (`mongosh mongodb://localhost:27017`)
  - [ ] Connector started successfully (`Started ApplicationConnector...`)
  
- [ ] **DCP Module Active**
  - [ ] Health check returns UP (`curl http://localhost:8080/actuator/health`)
  - [ ] Logs show "DcpHolderAutoConfiguration matched"
  - [ ] No errors in startup logs
  
- [ ] **DIDs Configured**
  - [ ] DID documents published and accessible
  - [ ] Service endpoints in DID docs are correct
  - [ ] DIDs use correct format (URL-encoded colons)
  
- [ ] **Authentication Ready**
  - [ ] Bearer tokens available (if using auth)
  - [ ] VP auth enabled (if using: `dcp.vp.enabled=true`)
  
- [ ] **Network Connectivity**
  - [ ] Connectors can reach each other
  - [ ] Firewalls allow traffic on required ports
  - [ ] DNS/hostnames resolve correctly
  
- [ ] **Debug Logging Enabled** (for troubleshooting)
  - [ ] `logging.level.it.eng.dcp=DEBUG`
  - [ ] Logs directory writable

---

## üìö Related Documentation

- [Non-Technical Overview](verifiable-credentials-overview.md)
- [Technical Guide](verifiable-credentials-technical.md)
- [Documentation Index](verifiable-credentials-index.md)
- [Detailed VC/DID Concepts](verifiable_credentials.md)
- [Identity Hub Setup](../../doc/identity_hub.md)
- [DCP Module README](../README.md)
- [Quick Start Guide](quick_start.md)

---

## üí° Quick Tips

1. **Always Configure First**: Edit `application.properties` BEFORE starting the connector
2. **Use Postman Collection**: Import `True_connector_DSP.postman_collection.json` for ready-to-use requests
3. **Enable Debug Logs**: Set `logging.level.it.eng.dcp=DEBUG` to see detailed flow
4. **Check MongoDB**: Always verify credentials are stored with `db.verifiable_credentials.find()`
5. **Decode JWTs**: Use [jwt.io](https://jwt.io) to inspect JWT VCs and VPs
6. **URL-Encode DIDs**: Remember to encode colons as `%3A` in DIDs for web method
7. **Test Locally First**: Use `localhost` DIDs for initial testing before production DIDs
8. **Group by Profile**: VPs must contain credentials with same profileId
9. **Keep JWTs**: Store original JWT representation in `jwtRepresentation` field
10. **Verify Health**: Always check `/actuator/health` after configuration changes

---

## üö¶ Startup Sequence Summary

```
1. Edit application.properties
   ‚îú‚îÄ‚îÄ Set dcp.enabled=true
   ‚îú‚îÄ‚îÄ Configure dcp.trusted-issuers
   ‚îú‚îÄ‚îÄ Set MongoDB URI
   ‚îî‚îÄ‚îÄ Enable debug logging

2. Ensure MongoDB is running
   ‚îî‚îÄ‚îÄ docker ps | grep mongo

3. Start connector
   ‚îî‚îÄ‚îÄ cd connector && mvn spring-boot:run

4. Wait for startup
   ‚îî‚îÄ‚îÄ "Started ApplicationConnector in X seconds"

5. Verify health
   ‚îî‚îÄ‚îÄ curl http://localhost:8080/actuator/health

6. Send API requests
   ‚îî‚îÄ‚îÄ Use curl commands or Postman
```

**Only proceed to step 6 when steps 1-5 are complete!**

### 1. Request Credentials (Holder)
```bash
curl -X POST http://localhost:8080/issuer/credentials \
  -H "Authorization: Bearer <holder-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "@context": ["https://w3id.org/dspace-dcp/v1.0/dcp.jsonld"],
    "type": "CredentialRequestMessage",
    "holderPid": "did:web:localhost%3A8081:holder",
    "credentials": [{"id": "membership-credential"}]
  }'
```

**Response:** `Location: /issuer/requests/req-abc123`

### 2. Approve Request (Issuer)
```bash
curl -X POST http://localhost:8080/issuer/requests/req-abc123/approve \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 3. Query Presentation (Verifier)
```bash
curl -X POST http://localhost:8081/dcp/presentations/query \
  -H "Authorization: Bearer <verifier-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "@context": ["https://w3id.org/dspace-dcp/v1.0/dcp.jsonld"],
    "type": "PresentationQueryMessage",
    "scope": ["MembershipCredential"]
  }'
```

### 4. Create Participant (Identity Hub)
```bash
curl -X POST http://localhost:8182/api/identity/v1alpha/participants/ \
  -H "X-Api-Key: c3VwZXItdXNlcg==.c3VwZXItc2VjcmV0Cg==" \
  -H "Content-Type: application/json" \
  -d '{
    "participantId": "did:web:consumer-identityhub%3A7083:consumer",
    "did": "did:web:consumer-identityhub%3A7083:consumer",
    "active": true,
    "serviceEndpoints": [...],
    "key": {...}
  }'
```

---

## üîß Configuration Properties

### Enable DCP Module
```properties
# application.properties
dcp.enabled=true
```

### Configure Trusted Issuers
```properties
dcp.trusted-issuers=did:web:issuer.example,did:web:dataspace-authority
```

### Enable VP Authentication
```properties
dcp.vp.enabled=true
dcp.vp.scope=MembershipCredential,OrganizationCredential
```

### Debug Logging
```properties
logging.level.it.eng.dcp=DEBUG
logging.level.org.springframework.security=DEBUG
```

---

## üóÇÔ∏è Key File Locations

### DCP Module
```
dcp/src/main/java/it/eng/dcp/
‚îú‚îÄ‚îÄ rest/
‚îÇ   ‚îú‚îÄ‚îÄ DcpController.java          # Holder endpoints
‚îÇ   ‚îî‚îÄ‚îÄ IssuerController.java       # Issuer endpoints
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ HolderService.java
‚îÇ   ‚îú‚îÄ‚îÄ PresentationService.java
‚îÇ   ‚îú‚îÄ‚îÄ PresentationValidationService.java
‚îÇ   ‚îî‚îÄ‚îÄ IssuerService.java
‚îî‚îÄ‚îÄ model/
    ‚îú‚îÄ‚îÄ VerifiableCredential.java
    ‚îî‚îÄ‚îÄ VerifiablePresentation.java
```

### Connector Authentication
```
connector/src/main/java/it/eng/connector/configuration/
‚îú‚îÄ‚îÄ VcVpAuthenticationFilter.java
‚îú‚îÄ‚îÄ VcVpAuthenticationProvider.java
‚îî‚îÄ‚îÄ WebSecurityConfig.java
```

---

## üîç MongoDB Queries

### List All Credentials
```javascript
db.verifiable_credentials.find().pretty()
```

### Find Credentials by Type
```javascript
db.verifiable_credentials.find({
  credentialType: "MembershipCredential"
}).pretty()
```

### Find Credentials by Holder
```javascript
db.verifiable_credentials.find({
  holderDid: "did:web:localhost:8080"
}).pretty()
```

### List Credential Requests
```javascript
db.credential_requests.find().pretty()
```

### Check Request Status
```javascript
db.credential_requests.find({
  _id: "req-abc123"
}).pretty()
```

---

## üêõ Troubleshooting Quick Fixes

### Issue: Credentials not being saved
**Check:**
```bash
# Verify MongoDB is running
docker ps | grep mongo

# Check database connection
curl http://localhost:8080/actuator/health | jq .components.mongo
```

### Issue: VP validation fails
**Check:**
```properties
# Ensure issuer is trusted
dcp.trusted-issuers=did:web:issuer.example

# Check credential expiration
# MongoDB query:
db.verifiable_credentials.find({
  expirationDate: { $lt: new Date() }
})
```

### Issue: DID resolution fails
**Check:**
```bash
# Verify DID document is accessible
curl https://localhost:8080/.well-known/did.json

# Check DID format (URL-encoded colons)
# Correct: did:web:localhost%3A8080:holder
# Wrong:   did:web:localhost:8080:holder
```

### Issue: Authentication fails
**Check:**
```bash
# Verify filter order in logs
grep "VcVpAuthenticationFilter" logs/connector.log

# Check authentication provider
grep "VcVpAuthenticationProvider" logs/connector.log
```

---

## üìä Status Codes

| Code | Meaning | Action |
|------|---------|--------|
| 201 Created | Credential request created | Note the `Location` header |
| 200 OK | Success | Request completed |
| 400 Bad Request | Invalid payload | Check JSON format |
| 401 Unauthorized | Missing/invalid auth | Verify Bearer token |
| 403 Forbidden | Untrusted issuer | Add to `dcp.trusted-issuers` |
| 404 Not Found | Request ID not found | Check request ID |
| 500 Internal Error | Server error | Check logs |

---

## üîê DID Format Reference

### Web DID Format
```
did:web:{domain}[:{port}][:{path}][#{fragment}]
```

### Examples
```
did:web:example.com
did:web:localhost%3A8080
did:web:localhost%3A8080:holder
did:web:dataspace-issuer#key-1
```

### Resolution
```
did:web:example.com 
  ‚Üí https://example.com/.well-known/did.json

did:web:localhost%3A8080:holder
  ‚Üí https://localhost:8080/holder/.well-known/did.json
```

---

## üìù Example Credential Structure

### JWT VC (Compact Format)
```
eyJraWQiOiJkaWQ6ZXhhbXBsZTppc3N1ZXI0NTYja2V5LTEiLCJhbGciOiJFUzI1NiJ9.eyJzdWIi...
```

**Decoded:**
```json
{
  "iss": "did:example:issuer456",
  "sub": "did:example:holder123",
  "vc": {
    "type": ["VerifiableCredential", "MembershipCredential"],
    "credentialSubject": {
      "id": "did:example:holder123",
      "membershipType": "Premium"
    }
  },
  "iat": 1733363431,
  "exp": 1764899431
}
```

### JSON-LD VC
```json
{
  "@context": ["https://www.w3.org/2018/credentials/v1"],
  "type": ["VerifiableCredential", "MembershipCredential"],
  "issuer": "did:example:issuer456",
  "issuanceDate": "2024-12-08T12:30:00Z",
  "credentialSubject": {
    "id": "did:example:holder123",
    "membershipType": "Premium"
  },
  "proof": {
    "type": "JsonWebSignature2020",
    "verificationMethod": "did:example:issuer456#key-1",
    "jws": "eyJhbGc..."
  }
}
```

---

## üéØ Testing Checklist

- [ ] DCP module enabled (`dcp.enabled=true`)
- [ ] MongoDB running and accessible
- [ ] Trusted issuers configured
- [ ] DID documents published and accessible
- [ ] Service endpoints in DID documents correct
- [ ] Authentication tokens valid
- [ ] Credentials not expired
- [ ] Network connectivity between connectors
- [ ] Logs show no errors
- [ ] Integration tests passing

---

## üìö Related Documentation

- [Non-Technical Overview](verifiable-credentials-overview.md)
- [Technical Guide](verifiable-credentials-technical.md)
- [Detailed VC/DID Concepts](verifiable_credentials.md)
- [Identity Hub Setup](../../doc/identity_hub.md)
- [DCP Module README](../README.md)
- [Quick Start Guide](quick_start.md)

---

## üí° Quick Tips

1. **Use Postman Collection**: Import `True_connector_DSP.postman_collection.json` for ready-to-use requests
2. **Enable Debug Logs**: Set `logging.level.it.eng.dcp=DEBUG` to see detailed flow
3. **Check MongoDB**: Always verify credentials are stored with `db.verifiable_credentials.find()`
4. **Decode JWTs**: Use [jwt.io](https://jwt.io) to inspect JWT VCs and VPs
5. **URL-Encode DIDs**: Remember to encode colons as `%3A` in DIDs for web method
6. **Test Locally First**: Use `localhost` DIDs for initial testing before production DIDs
7. **Group by Profile**: VPs must contain credentials with same profileId
8. **Keep JWTs**: Store original JWT representation in `jwtRepresentation` field
