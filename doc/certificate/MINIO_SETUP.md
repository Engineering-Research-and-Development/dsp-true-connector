# MinIO TLS Configuration Guide

This guide explains how to configure TLS/SSL for MinIO using certificates generated by the `generate-certificates.cmd` script.

## Overview

MinIO requires certificates in **PEM format**:
- `private.key` - Private key in PEM format
- `public.crt` - Certificate (with chain) in PEM format

The `generate-certificates.cmd` script automatically generates these files, signed by the same Intermediate CA used for connector-a and connector-b.

## Certificate Generation

### Quick Start

1. Run the certificate generation script:
```cmd
cd connector/src/main/resources
generate-certificates.cmd
```

2. The script will generate:
   - `private.key` - MinIO private key in PEM format
   - `public.crt` - MinIO certificate in PEM format (signed by Intermediate CA)
   - `minio-temp.p12` - Temporary PKCS12 keystore (optional, can be deleted)

### MinIO Certificate Details

The MinIO certificate has the following configuration:

**Subject Alternative Names (SANs):**
```
DNS:localhost
DNS:minio
IP:127.0.0.1
```

**Key Usage:**
- Digital Signature
- Key Encipherment

**Extended Key Usage:**
- Server Authentication
- Client Authentication

**Validity:** 365 days (1 year)

**Signed By:** DSP Intermediate CA

## MinIO Docker Configuration

### Directory Structure

MinIO expects certificates in specific locations:
```
/root/.minio/certs/
â”œâ”€â”€ private.key    # Private key
â”œâ”€â”€ public.crt     # Certificate with chain
â””â”€â”€ CAs/           # Optional: Trusted CA certificates
    â””â”€â”€ intermediate-ca.crt
```

### Option 1: Docker Compose with Volume Mounts

Update your `docker-compose.yml`:

```yaml
services:
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      # Mount certificate files
      - ./connector/src/main/resources/private.key:/root/.minio/certs/private.key:ro
      - ./connector/src/main/resources/public.crt:/root/.minio/certs/public.crt:ro
      # Optional: Mount trusted CAs
      - ./connector/src/main/resources/intermediate-ca.crt:/root/.minio/certs/CAs/intermediate-ca.crt:ro
    command: server /data --console-address ":9001"
    networks:
      - dsp-network
```

### Option 2: Copy Files into Container

If you prefer to copy files instead of mounting:

```cmd
# Build custom MinIO image
docker build -t minio-with-certs -f Dockerfile.minio .
```

**Dockerfile.minio:**
```dockerfile
FROM minio/minio:latest

# Copy certificates
COPY connector/src/main/resources/private.key /root/.minio/certs/private.key
COPY connector/src/main/resources/public.crt /root/.minio/certs/public.crt
COPY connector/src/main/resources/intermediate-ca.crt /root/.minio/certs/CAs/intermediate-ca.crt

# Set permissions
RUN chmod 600 /root/.minio/certs/private.key
RUN chmod 644 /root/.minio/certs/public.crt

CMD ["server", "/data", "--console-address", ":9001"]
```

### Option 3: Manual Copy to Running Container

```cmd
# Copy files to running container
docker cp private.key minio:/root/.minio/certs/private.key
docker cp public.crt minio:/root/.minio/certs/public.crt

# Set permissions
docker exec minio chmod 600 /root/.minio/certs/private.key
docker exec minio chmod 644 /root/.minio/certs/public.crt

# Restart MinIO
docker restart minio
```

## Verifying MinIO TLS Configuration

### 1. Check MinIO Logs

```cmd
docker logs minio
```

Look for:
```
API: https://172.18.0.2:9000  https://127.0.0.1:9000
Console: https://172.18.0.2:9001 https://127.0.0.1:9001

Documentation: https://min.io/docs/minio/linux/index.html
```

The `https://` prefix indicates TLS is enabled.

### 2. Test HTTPS Connection

```cmd
curl -v https://localhost:9000
```

Expected output:
```
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* Server certificate:
*  subject: CN=minio, OU=Storage, O=DSP True Connector, L=Belgrade, ST=Serbia, C=RS
*  issuer: CN=DSP Intermediate CA, OU=Security, O=DSP True Connector, L=Belgrade, ST=Serbia, C=RS
```

### 3. Verify Certificate Chain

```cmd
openssl s_client -connect localhost:9000 -showcerts
```

Should show:
1. Server certificate (CN=minio)
2. Intermediate CA certificate
3. Verify return code: 0 (ok)

### 4. Test with MinIO Client (mc)

```cmd
# Configure mc client
mc alias set myminio https://localhost:9000 minioadmin minioadmin

# Test connection
mc admin info myminio
```

## Application Configuration

### Spring Boot Configuration (application.properties)

```properties
# S3/MinIO Configuration
application.s3.endpoint=https://localhost:9000
application.s3.access-key=minioadmin
application.s3.secret-key=minioadmin
application.s3.bucket-name=dsp-bucket
application.s3.region=us-east-1

# SSL Configuration
application.ssl.enabled=true

# SSL Bundle - includes truststore with Intermediate CA
spring.ssl.bundle.jks.connector.truststore.location=classpath:dsp-truststore.p12
spring.ssl.bundle.jks.connector.truststore.password=password
spring.ssl.bundle.jks.connector.truststore.type=PKCS12
```

### S3 Client Configuration (Java)

The `S3ClientProvider` automatically uses the truststore configured in the SSL bundle:

```java
@Configuration
public class S3HttpClientFactory {
    
    @Bean
    public SdkHttpClient sdkHttpClient(SslBundles sslBundles) {
        if (sslEnabled) {
            SSLContext sslContext = sslBundles.getBundle("connector")
                .createSslContext();
            
            return ApacheHttpClient.builder()
                .tlsSocketFactory(ApacheSdkHttpFactory.of(sslContext))
                .build();
        }
        return ApacheHttpClient.builder().build();
    }
}
```

This configuration ensures that:
1. âœ… MinIO server certificate is signed by Intermediate CA
2. âœ… Application truststore contains Intermediate CA
3. âœ… TLS handshake succeeds
4. âœ… Hostname verification passes (SAN includes "localhost" and "minio")

## Troubleshooting

### Issue: MinIO doesn't start with TLS

**Symptoms:**
```
ERROR Unable to load the TLS configuration: tls: failed to find certificate
```

**Solution:**
- Verify `private.key` and `public.crt` exist in `/root/.minio/certs/`
- Check file permissions (private.key should be 600, public.crt should be 644)
- Ensure files are in PEM format (should start with `-----BEGIN`)

### Issue: PKIX Exception when connecting from application

**Symptoms:**
```
sun.security.validator.ValidatorException: PKIX path building failed
```

**Solution:**
- Ensure `dsp-truststore.p12` contains the Intermediate CA certificate
- Verify application configuration points to the correct truststore
- Check that MinIO certificate is signed by the same Intermediate CA

**Verify:**
```cmd
# Check truststore contents
keytool -list -v -keystore dsp-truststore.p12 -storepass password

# Should show: Alias name: dsp-intermediate-ca
```

### Issue: Hostname verification failed

**Symptoms:**
```
java.security.cert.CertificateException: No subject alternative names matching IP address 172.18.0.2
```

**Solution:**
- Ensure you're connecting using a hostname/IP that's in MinIO certificate's SANs
- Valid hostnames: `localhost`, `minio`, `127.0.0.1`
- If connecting via Docker network, add the container name to SANs

**Update SANs:**
Edit `generate-certificates.cmd`:
```batch
set SAN_MINIO=DNS:localhost,DNS:minio,DNS:minio-container,IP:127.0.0.1
```

Then regenerate certificates:
```cmd
generate-certificates.cmd
```

### Issue: Certificate has expired

**Symptoms:**
```
sun.security.validator.ValidatorException: NotAfter: <date>
```

**Solution:**
- MinIO certificates are valid for 1 year
- Regenerate certificates using `generate-certificates.cmd`
- Update MinIO container with new certificates
- Restart MinIO

## Certificate Renewal

MinIO certificates expire after **365 days**. To renew:

### 1. Regenerate Certificates

```cmd
cd connector/src/main/resources
generate-certificates.cmd
```

### 2. Update MinIO

```cmd
# Copy new certificates
docker cp private.key minio:/root/.minio/certs/private.key
docker cp public.crt minio:/root/.minio/certs/public.crt

# Restart MinIO
docker restart minio
```

### 3. Verify

```cmd
# Check certificate expiration
openssl s_client -connect localhost:9000 -showcerts 2>/dev/null | openssl x509 -noout -dates
```

## Security Best Practices

### âœ… Production Recommendations

1. **Strong Passwords**
   - Change default MinIO root credentials
   - Use strong passwords in `generate-certificates.cmd`

2. **Certificate Validity**
   - Keep certificates valid and monitor expiration
   - Set up automated renewal (e.g., 30 days before expiry)

3. **Key Protection**
   - Protect `private.key` file (chmod 600)
   - Never commit private keys to version control
   - Store Root CA and Intermediate CA keystores securely

4. **Network Security**
   - Use TLS for all MinIO connections
   - Restrict MinIO network access using firewall rules
   - Use separate networks for different services in Docker

5. **Monitoring**
   - Monitor MinIO logs for TLS errors
   - Set up alerts for certificate expiration
   - Regular security audits

### ðŸ”’ File Permissions

```bash
# MinIO certificates
chmod 600 /root/.minio/certs/private.key  # Read/write owner only
chmod 644 /root/.minio/certs/public.crt   # Read all, write owner

# CA keystores (keep secure!)
chmod 600 dsp-root-ca.p12
chmod 600 dsp-intermediate-ca.p12

# Server keystores
chmod 644 connector-a.p12
chmod 644 connector-b.p12
chmod 644 dsp-truststore.p12
```

## Summary

âœ… **MinIO TLS Configuration Checklist:**

- [ ] Run `generate-certificates.cmd` to generate `private.key` and `public.crt`
- [ ] Copy certificates to MinIO container at `/root/.minio/certs/`
- [ ] Set correct file permissions (600 for private.key, 644 for public.crt)
- [ ] Restart MinIO container
- [ ] Verify TLS is enabled in MinIO logs (look for `https://`)
- [ ] Configure application to use `https://` endpoint
- [ ] Ensure application truststore contains Intermediate CA
- [ ] Test connection from application
- [ ] Set up certificate renewal monitoring

ðŸŽ‰ **Your MinIO instance is now secured with TLS!**

## Additional Resources

- [MinIO TLS Configuration Documentation](https://min.io/docs/minio/linux/operations/network-encryption.html)
- [Generate Certificates Script](./generate-certificates.cmd)
- [Certificate README](./CERTIFICATES_README.md)
- [PKI Architecture Guide](../../../doc/pki_architecture_guide.md)

